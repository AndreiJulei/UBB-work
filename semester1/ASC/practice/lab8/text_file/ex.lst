     1                                  bits 32 ; assembling for the 32 bits architecture
     2                                  
     3                                  ; declare the EntryPoint (a label defining the very first instruction of the program)
     4                                  global start        
     5                                  
     6                                  ; declare external functions needed by our program
     7                                  extern exit         ; tell nasm that exit exists even if we won't be defining it
     8                                  import exit msvcrt.dll    ; exit is a function that ends the calling process. It is defined in msvcrt.dll
     9                                                            ; msvcrt.dll contains exit, printf and all the other important C-runtime specific functions
    10                                  
    11                                  ; our data is declared here (the variables needed by our program)
    12                                  
    13                                  extern fopen, fprintf, fclose, fread,printf,scanf
    14                                  import fopen msvcrt.dll
    15                                  import fprintf msvcrt.dll
    16                                  import fclose msvcrt.dll
    17                                  import fread msvcrt.dll
    18                                  import printf msvcrt.dll
    19                                  import scanf msvcrt.dll
    20                                  
    21                                  segment data use32 class=data
    22                                      ; ...
    23                                  	
    24 00000000 7200                    	acces_mode_read db "r",0
    25 00000002 746578742E74787400      	file_path db "text.txt",0
    26 0000000B 6F75747075742E7478-     	output db "output.txt",0
    26 00000014 7400               
    27 00000016 <res 00000064>          	buffer resb 100
    28 0000007A <res 00000004>          	id resd 1
    29 0000007E 7700000000000000        	acces_mode_write dd "w",0
    30 00000086 2564000000000000        	format_number dd '%d',0
    31 0000008E 2573000000000000        	format_nume dd '%s',0
    32 00000096 0A00000000000000        	newline dd 10,0
    33 0000009E 00000000                	len dd 0
    34 000000A2 00000000                	new_name dd 0
    35 000000A6 00000000                	number dd 0
    36                                  
    37                                  	
    38                                  ; our code starts here
    39                                  segment code use32 class=code
    40                                      start:
    41                                          ; ...
    42 00000000 31DB                    		xor ebx,ebx
    43                                  		
    44 00000002 68[00000000]            		push acces_mode_read
    45 00000007 68[02000000]            		push file_path
    46 0000000C FF15[00000000]          		call [fopen]
    47 00000012 83C408                  		add esp,4*2
    48                                  		
    49 00000015 A3[7A000000]            		mov [id],eax
    50                                  		
    51 0000001A 83F800                  		cmp eax,0
    52 0000001D 0F8409010000            		je _end_
    53                                  		
    54                                  		read_while_there_are_characters:
    55                                  			
    56 00000023 50                      			push eax
    57 00000024 6A64                    			push dword 100
    58 00000026 6A01                    			push dword 1
    59 00000028 68[16000000]            			push buffer
    60 0000002D FF15[00000000]          			call [fread]
    61 00000033 83C410                  			add esp,4*4
    62                                  			
    63 00000036 BE00000000              			mov esi,0
    64 0000003B A3[9E000000]            			mov [len],eax
    65                                  			
    66 00000040 BF[A2000000]            			mov edi,new_name
    67                                  			
    68                                  			get_name:
    69 00000045 8A86[16000000]          			mov al,[buffer+esi]		; AL = buffer[0]
    70 0000004B 46                      			inc esi
    71 0000004C 3C20                    			cmp al,' '
    72 0000004E 7405                    			je name_is_saved
    73 00000050 8807                    			mov byte[edi],al
    74 00000052 47                      			inc edi
    75 00000053 EBF0                    			jmp get_name
    76                                  			
    77                                  		name_is_saved:
    78                                  			
    79 00000055 BE00000000              			mov esi,0
    80                                  			
    81                                  			find_number:
    82 0000005A 8A86[16000000]          			mov al,[buffer+esi]
    83 00000060 3C00                    			cmp al,0
    84 00000062 740F                    			je done
    85                                  			
    86 00000064 3C30                    			cmp al,'0'
    87 00000066 7C08                    			jl next_char
    88                                  			
    89 00000068 3C39                    			cmp al,'9'
    90 0000006A 7F04                    			jg next_char
    91                                  			
    92 0000006C 88C7                    			mov bh,al
    93 0000006E EB03                    			jmp done
    94                                  			
    95                                  			next_char:
    96 00000070 46                      			inc esi
    97 00000071 EBE7                    			jmp find_number
    98                                  			
    99                                  			done:
   100                                  			
   101 00000073 B331                    			mov bl,'1'
   102 00000075 66891D[A6000000]        			mov [number],bx
   103                                  		
   104                                  		
   105 0000007C 803D[9E000000]64        		cmp byte[len],100
   106 00000083 739E                    		jae read_while_there_are_characters
   107                                  		
   108 00000085 FF35[7A000000]          		push dword [id]
   109 0000008B FF15[00000000]          		call [fclose]
   110 00000091 83C404                  		add esp,4
   111                                  		
   112 00000094 68[7E000000]            		push acces_mode_write
   113 00000099 68[0B000000]            		push output
   114 0000009E FF15[00000000]          		call [fopen]
   115 000000A4 83C408                  		add esp,4*2
   116                                  		
   117                                  		
   118 000000A7 A3[7A000000]            		mov [id],eax
   119                                  		
   120 000000AC FF35[9E000000]          		push dword [len]
   121 000000B2 68[86000000]            		push dword format_number
   122 000000B7 FF35[7A000000]          		push dword [id]
   123 000000BD FF15[00000000]          		call [fprintf]
   124 000000C3 83C40C                  		add esp,4*3
   125                                  		
   126 000000C6 68[96000000]            		push dword newline
   127 000000CB FF35[7A000000]          		push dword [id]
   128 000000D1 FF15[00000000]          		call [fprintf]
   129 000000D7 83C404                  		add esp,4
   130                                  		
   131 000000DA 68[A2000000]            		push dword new_name
   132 000000DF 68[8E000000]            		push dword format_nume
   133 000000E4 FF35[7A000000]          		push dword [id]
   134 000000EA FF15[00000000]          		call [fprintf]
   135 000000F0 83C40C                  		add esp,4*3
   136                                  		
   137 000000F3 68[96000000]            		push dword newline
   138 000000F8 FF35[7A000000]          		push dword [id]
   139 000000FE FF15[00000000]          		call [fprintf]
   140 00000104 83C404                  		add esp,4
   141                                  		
   142 00000107 68[A6000000]            		push dword number
   143 0000010C 68[8E000000]            		push dword format_nume
   144 00000111 FF35[7A000000]          		push dword [id]
   145 00000117 FF15[00000000]          		call [fprintf]
   146 0000011D 83C40C                  		add esp,4*3
   147                                  		
   148                                  		
   149 00000120 FF35[7A000000]          		push dword[id]
   150 00000126 FF15[00000000]          		call [fclose]
   151                                  				
   152                                  		_end_:
   153                                          ; exit(0)
   154 0000012C 6A00                            push    dword 0      ; push the parameter for exit onto the stack
   155 0000012E FF15[00000000]                  call    [exit]       ; call exit to terminate the program
